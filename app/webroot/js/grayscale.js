/*
 * -- grayscale.js --
 * Copyright (C) James Padolsey (http://james.padolsey.com)
 *
 */

var grayscale=(function(){var n={colorProps:['color','backgroundColor','borderBottomColor','borderTopColor','borderLeftColor','borderRightColor','backgroundImage'],externalImageHandler:{init:function(a,b){if(a.nodeName.toLowerCase()==='img'){}else{data(a).backgroundImageSRC=b;a.style.backgroundImage=''}},reset:function(a){if(a.nodeName.toLowerCase()==='img'){}else{a.style.backgroundImage='url('+(data(a).backgroundImageSRC||'')+')'}}}},log=function(){try{window.console.log.apply(console,arguments)}catch(e){}},isExternal=function(a){return(new RegExp('https?://(?!'+window.location.hostname+')')).test(a)},data=(function(){var c=[0],expando='data'+(+new Date());return function(a){var b=a[expando],nextCacheIndex=c.length;if(!b){b=a[expando]=nextCacheIndex;c[b]={}}return c[b]}})(),desatIMG=function(a,b,c){var d=document.createElement('canvas'),context=d.getContext('2d'),height=a.naturalHeight||a.offsetHeight||a.height,width=a.naturalWidth||a.offsetWidth||a.width,imgData;d.height=height;d.width=width;context.drawImage(a,0,0);try{imgData=context.getImageData(0,0,width,height)}catch(e){}if(b){desatIMG.preparing=true;var y=0;(function(){if(!desatIMG.preparing){return}if(y===height){context.putImageData(imgData,0,0,0,0,width,height);c?(data(c).BGdataURL=d.toDataURL()):(data(a).dataURL=d.toDataURL())}for(var x=0;x<width;x++){var i=(y*width+x)*4;imgData.data[i]=imgData.data[i+1]=imgData.data[i+2]=RGBtoGRAYSCALE(imgData.data[i],imgData.data[i+1],imgData.data[i+2])}y++;setTimeout(arguments.callee,0)})();return}else{desatIMG.preparing=false}for(var y=0;y<height;y++){for(var x=0;x<width;x++){var i=(y*width+x)*4;imgData.data[i]=imgData.data[i+1]=imgData.data[i+2]=RGBtoGRAYSCALE(imgData.data[i],imgData.data[i+1],imgData.data[i+2])}}context.putImageData(imgData,0,0,0,0,width,height);return d},getStyle=function(a,b){var c=document.defaultView&&document.defaultView.getComputedStyle?document.defaultView.getComputedStyle(a,null)[b]:a.currentStyle[b];if(c&&/^#[A-F0-9]/i.test(c)){var d=c.match(/[A-F0-9]{2}/ig);c='rgb('+parseInt(d[0],16)+','+parseInt(d[1],16)+','+parseInt(d[2],16)+')'}return c},RGBtoGRAYSCALE=function(r,g,b){return parseInt((0.2125*r)+(0.7154*g)+(0.0721*b),10)},getAllNodes=function(a){var b=Array.prototype.slice.call(a.getElementsByTagName('*'));b.unshift(a);return b};var o=function(b){if(b&&b[0]&&b.length&&b[0].nodeName){var c=Array.prototype.slice.call(b),cIndex=-1,cLen=c.length;while(++cIndex<cLen){o.call(this,c[cIndex])}return}b=b||document.documentElement;if(!document.createElement('canvas').getContext){b.style.filter='progid:DXImageTransform.Microsoft.BasicImage(grayscale=1) alpha(opacity=60)';b.style.zoom=1;return}var d=getAllNodes(b),i=-1,len=d.length;while(++i<len){var f=d[i];if(f.nodeName.toLowerCase()==='img'){var g=f.getAttribute('src');if(!g){continue}if(isExternal(g)){n.externalImageHandler.init(f,g)}else{data(f).realSRC=g;try{f.src=data(f).dataURL||desatIMG(f).toDataURL()}catch(e){n.externalImageHandler.init(f,g)}}}else{for(var h=0,pLen=n.colorProps.length;h<pLen;h++){var j=n.colorProps[h],style=getStyle(f,j);if(!style){continue}if(f.style[j]){data(f)[j]=style}if(style.substring(0,4)==='rgb('){var k=RGBtoGRAYSCALE.apply(null,style.match(/\d+/g));f.style[j]=style='rgb('+k+','+k+','+k+')';continue}if(style.indexOf('url(')>-1){var l=/\(['"]?(.+?)['"]?\)/,url=style.match(l)[1];if(isExternal(url)){n.externalImageHandler.init(f,url);data(f).externalBG=true;continue}try{var m=data(f).BGdataURL||(function(){var a=document.createElement('img');a.src=url;return desatIMG(a).toDataURL()})();f.style[j]=style.replace(l,function(_,a){return'('+m+')'})}catch(e){n.externalImageHandler.init(f,url)}}}}}};o.reset=function(a){if(a&&a[0]&&a.length&&a[0].nodeName){var b=Array.prototype.slice.call(a),cIndex=-1,cLen=b.length;while(++cIndex<cLen){o.reset.call(this,b[cIndex])}return}a=a||document.documentElement;if(!document.createElement('canvas').getContext){a.style.filter='progid:DXImageTransform.Microsoft.BasicImage(grayscale=0)';return}var c=getAllNodes(a),i=-1,len=c.length;while(++i<len){var d=c[i];if(d.nodeName.toLowerCase()==='img'){var e=d.getAttribute('src');if(isExternal(e)){n.externalImageHandler.reset(d,e)}d.src=data(d).realSRC||e}else{for(var f=0,pLen=n.colorProps.length;f<pLen;f++){if(data(d).externalBG){n.externalImageHandler.reset(d)}var g=n.colorProps[f];d.style[g]=data(d)[g]||''}}}};o.prepare=function(a){if(a&&a[0]&&a.length&&a[0].nodeName){var b=Array.prototype.slice.call(a),cIndex=-1,cLen=b.length;while(++cIndex<cLen){o.prepare.call(null,b[cIndex])}return}a=a||document.documentElement;if(!document.createElement('canvas').getContext){return}var c=getAllNodes(a),i=-1,len=c.length;while(++i<len){var d=c[i];if(data(d).skip){return}if(d.nodeName.toLowerCase()==='img'){if(d.getAttribute('src')&&!isExternal(d.src)){desatIMG(d,true)}}else{var e=getStyle(d,'backgroundImage');if(e.indexOf('url(')>-1){var f=/\(['"]?(.+?)['"]?\)/,url=e.match(f)[1];if(!isExternal(url)){var g=document.createElement('img');g.src=url;desatIMG(g,true,d)}}}}};return o})();